<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon_io (1)/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon_io (1)/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon_io (1)/favicon-16x16.png">
    <link rel="manifest" href="/favicon_io (1)/site.webmanifest">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academic Quizzes | NepalQuiz</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700&family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <script src="https://kit.fontawesome.com/a2e0c6ad89.js" crossorigin="anonymous"></script>

    <style>
        /* New Sky Blue and White Light Theme Variables */
        :root {
            --nq-primary-blue: #60A5FA; /* A bright, medium sky blue */
            --nq-background-light: #FFFFFF; /* Pure white background */
            --nq-background-soft-light: #F0F4F8; /* Soft light gray for cards */
            --nq-accent-blue: #2563EB; /* A deeper, vibrant blue for accents */
            --nq-text-dark: #1F2937; /* Dark gray for primary text */
            --nq-text-light: #6B7280; /* Lighter gray for secondary text */
            --nq-shadow-color: rgba(0, 0, 0, 0.1); /* Subtle shadow for light theme */

            /* Quiz specific colors from fun.html (adjusted for consistency) */
            --green: #16a34a; /* for correct answers */
            --red: #ef4444; /* for wrong answers */
            --light-green: #d1fae5; /* for correct answers light bg */
            --light-red: #ffe4e6; /* for wrong answers light bg */
            --border-color-light: rgba(0, 0, 0, 0.1); /* light border for light theme */
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--nq-background-light); /* Use the new light background */
            color: var(--nq-text-dark); /* Use the new dark text color */
            margin: 0;
            line-height: 1.6;
            overflow-x: hidden; /* Prevent horizontal scroll due to animations */
        }

        header {
            background-color: var(--nq-primary-blue); /* Header background with primary blue */
            padding: 1rem 1.5rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px var(--nq-shadow-color); /* Add a subtle shadow to the header */
        }

        header .logo {
            font-weight: 800;
            font-size: 1.8rem; /* Slightly larger logo */
            color: var(--nq-background-light); /* White logo on blue background */
            letter-spacing: 0.5px;
        }

        nav a {
            color: var(--nq-background-light); /* White links on blue background */
            margin: 0 0.8rem; /* Increased margin for better spacing */
            text-decoration: none;
            font-weight: 600;
            font-size: 1.05rem;
            transition: color 0.3s ease, transform 0.2s ease;
        }
        nav a:hover {
            color: var(--nq-accent-blue); /* Accent blue on hover */
            transform: translateY(-2px);
        }

        .section {
            padding: 4rem 1.5rem; /* Increased padding for sections */
            max-width: 1200px;
            margin: auto;
        }

        h2 {
            text-align: center;
            color: var(--nq-accent-blue); /* Headings in accent blue */
            font-size: 2.5rem; /* Larger heading font size */
            margin-bottom: 2.5rem; /* More space below headings */
            font-weight: 700;
        }

        /* Styles for Academic Page layout */
        .academic-content-area {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            background-color: var(--nq-background-soft-light);
            padding: 2.5rem;
            border-radius: 1.25rem;
            box-shadow: 0 4px 15px var(--nq-shadow-color);
        }

        .subject-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .subject-card {
            background-color: var(--nq-background-light); /* White background for subject cards */
            border-radius: 1.25rem;
            padding: 2.5rem;
            box-shadow: 0 4px 15px var(--nq-shadow-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid var(--border-color-light); /* Added border */
        }

        .subject-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(37, 99, 235, 0.25);
        }

        .subject-card h3 {
            font-size: 2rem;
            color: var(--nq-accent-blue);
            text-align: center;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--nq-accent-blue);
            padding-bottom: 1rem;
        }

        .chapter-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .chapter-list li {
            margin-bottom: 1rem; /* Reduced margin for tighter list */
        }

        .chapter-list li button { /* Changed a to button */
            display: block;
            width: 100%;
            text-align: left;
            background-color: var(--nq-background-soft-light); /* Soft light background for chapter buttons */
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            text-decoration: none;
            color: var(--nq-text-dark);
            font-weight: 600;
            font-size: 1.1rem;
            transition: background-color 0.3s ease, transform 0.2s ease, color 0.3s ease;
            box-shadow: 0 2px 8px var(--nq-shadow-color);
            border: none; /* Remove default button border */
            cursor: pointer;
        }

        .chapter-list li button:hover {
            background-color: var(--nq-accent-blue);
            color: var(--nq-background-light);
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        /* Quiz Specific Styles (from fun.html) */
        .quiz-card {
            background: var(--nq-background-soft-light); /* Consistent soft light background */
            border-radius: 12px;
            padding: 25px; /* Increased padding */
            box-shadow: 0 6px 18px var(--nq-shadow-color); /* Subtle shadow */
            margin-bottom: 16px;
            border: 1px solid var(--nq-primary-blue); /* Border color */
        }
        .quiz-card h2 {
            color: var(--nq-accent-blue);
            margin: 6px 0 14px;
            font-size: 1.8rem; /* Slightly smaller for quiz card h2 */
        }
        .option-btn {
            display: block;
            width: 100%;
            text-align: left;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--nq-primary-blue);
            margin: 8px 0;
            background: var(--nq-background-light); /* White background for options */
            color: var(--nq-text-dark); /* Dark text */
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            font-size: 1.05rem;
        }
        .option-btn:hover:not([data-answered="true"]) {
            background: var(--nq-primary-blue); /* Primary blue on hover */
            color: var(--nq-background-light); /* White text on hover */
            border-color: var(--nq-accent-blue);
        }
        .option-btn[data-answered="true"]) {
            cursor: default; /* No hover after answer */
        }
        #quiz-area .controls button {
            background: var(--nq-primary-blue); /* Primary blue for controls */
            color: var(--nq-background-light); /* White text for controls */
            border: 1px solid var(--nq-accent-blue);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 1rem;
            flex: 1; /* Distribute space */
            min-width: 100px; /* Ensure buttons don't get too small */
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        #quiz-area .controls button:hover:not([disabled]) {
            background: var(--nq-accent-blue);
            color: var(--nq-background-light); /* White text on hover */
            transform: translateY(-2px);
        }
        #quiz-area .controls button[disabled]) {
            opacity: .6;
            cursor: not-allowed;
        }

        /* Specific control button colors */
        #submit-btn { background-color: var(--green); border-color: var(--green); }
        #submit-btn:hover:not([disabled]) { background-color: #128a3f; }
        #restart-btn { background-color: var(--red); border-color: var(--red); }
        #restart-btn:hover:not([disabled]) { background-color: #bb2f2f; }
        #save-result-btn { background-color: var(--nq-primary-blue); border-color: var(--nq-accent-blue); }
        #save-result-btn:hover:not([disabled]) { background-color: var(--nq-accent-blue); color: var(--nq-background-light); } /* White text on hover */

        #countdown {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--nq-accent-blue);
            margin-bottom: 10px;
        }
        #explanation {
            margin-top: 15px;
            font-style: italic;
            color: var(--nq-text-dark);
            padding: 10px;
            background: var(--nq-background-soft-light); /* Soft light background */
            border-radius: 8px;
            border: 1px solid var(--nq-primary-blue);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); /* Slightly lighter overlay for light theme */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: var(--nq-background-light); /* White background for modal */
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 90%;
            text-align: center;
            position: relative;
            color: var(--nq-text-dark); /* Dark text */
            border: 1px solid var(--nq-primary-blue);
        }
        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.5rem;
            cursor: pointer;
            background: none;
            border: none;
            color: var(--nq-text-dark);
            padding: 0;
        }
        .modal-close-btn:hover {
            color: var(--nq-accent-blue);
        }
        .modal-content button {
            margin-top: 20px;
            padding: 10px 20px;
            background: var(--nq-accent-blue);
            color: var(--nq-background-light); /* White text on accent */
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: auto;
        }
        .modal-content button:hover {
            opacity: 0.9;
        }

        /* Results Area styling */
        #results-area {
            background: var(--nq-background-soft-light); /* Soft light background */
            border: 1px solid var(--nq-primary-blue);
            padding: 18px;
            border-radius: 12px;
            box-shadow: 0 6px 18px var(--nq-shadow-color);
        }
        #results-area h2 {
            color: var(--nq-accent-blue);
        }
        #results-area div {
            color: var(--nq-text-dark);
        }
        #local-history-display .participant {
            background: var(--nq-background-light); /* White background for history items */
            color: var(--nq-text-dark);
            border: 1px solid var(--nq-primary-blue);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        #local-history-display .participant strong {
            color: var(--nq-accent-blue);
        }
        #local-history-display .participant div:last-child {
            color: var(--nq-text-dark);
        }

        /* General styles for current/upcoming info */
        #status-area .info-card {
            background: var(--nq-background-soft-light);
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 6px 18px var(--nq-shadow-color);
            border: 1px solid var(--nq-primary-blue);
            color: var(--nq-text-dark);
        }
        #status-area .info-card h3 {
            color: var(--nq-accent-blue);
            font-size: 1.4rem;
            margin-top: 0;
            margin-bottom: 10px;
        }
        #status-area .info-card .meta {
            color: var(--nq-text-light);
        }

        .upcoming-quizzes {
            background-color: var(--nq-background-soft-light);
            border-radius: 1.25rem;
            padding: 2.5rem;
            text-align: center;
            box-shadow: 0 4px 15px var(--nq-shadow-color);
            margin-top: 4rem;
        }

        .upcoming-quizzes h3 {
            color: var(--nq-accent-blue);
            font-size: 1.8rem;
            margin-bottom: 1rem;
        }

        .upcoming-quizzes p {
            font-size: 1.1rem;
            color: var(--nq-text-light);
        }

        /* Footer */
        footer {
            background-color: var(--nq-primary-blue);
            color: var(--nq-background-light);
            padding: 3rem 1.5rem;
            font-size: 0.9rem;
        }

        .footer-content {
            max-width: 1200px;
            margin: auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 2rem;
            text-align: left;
        }

        .footer-column h4 {
            color: var(--nq-background-light);
            font-size: 1.2rem;
            margin-bottom: 1.2rem;
            font-weight: 600;
        }

        .footer-column ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .footer-column ul li {
            margin-bottom: 0.8rem;
        }

        .footer-column ul li a {
            color: var(--nq-background-light);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .footer-column ul li a:hover {
            color: var(--nq-accent-blue);
        }

        .social-icons a {
            color: var(--nq-background-light);
            font-size: 1.5rem;
            margin-right: 1rem;
            transition: color 0.3s ease;
        }

        .social-icons a:hover {
            color: var(--nq-accent-blue);
        }

        .footer-bottom {
            text-align: center;
            margin-top: 2.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Utility classes */
        .hidden {
            display: none !important;
        }
        .text-center {
            text-align: center;
        }
        .flex {
            display: flex;
        }
        .justify-between {
            justify-content: space-between;
        }
        .items-center {
            align-items: center;
        }
        .gap-4 {
            gap: 1rem;
        }
        .mt-8 {
            margin-top: 2rem;
        }
        .mb-4 {
            margin-bottom: 1rem;
        }
        .mb-6 {
            margin-bottom: 1.5rem;
        }
        .w-full {
            width: 100%;
        }
        .p-3 {
            padding: 0.75rem;
        }
        .rounded-lg {
            border-radius: 0.5rem;
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                padding: 1rem;
            }
            nav {
                margin-top: 1rem;
            }
            nav a {
                margin: 0 0.4rem;
                font-size: 0.95rem;
            }
            h2 {
                font-size: 2rem;
            }
            .section {
                padding: 2.5rem 1rem;
            }
            .subject-card {
                padding: 1.5rem;
            }
            .subject-card h3 {
                font-size: 1.8rem;
            }
            .chapter-list li button {
                font-size: 1rem;
            }
            .footer-content {
                grid-template-columns: 1fr;
                text-align: center;
            }
            .footer-column ul {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
            }
            .footer-column ul li {
                margin: 0.5rem 0.8rem;
            }
            .social-icons {
                margin-top: 1rem;
            }
            .academic-content-area {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>

<header>
    <div class="logo">NepalQuiz</div>
    <nav>
        <a href="/index.html">Home</a>
        <a href="/quizzes.html">Quizzes</a>
        <a href="/about-us.html">About Us</a>
        <a href="/contact.html">Contact</a>
    </nav>
</header>

<section id="academic-quizzes" class="section">
    <h2>Academic Quizzes</h2>
    <div id="academic-content-wrapper" class="academic-content-area">
        <!-- Initial Chapter/Subject Selection Area -->
        <div id="chapter-selection-area">
            <input type="text" id="participant-name-input" placeholder="Your name (for local history)" class="w-full p-3 rounded-lg bg-nq-background-light text-nq-text-dark border border-nq-primary-blue focus:ring-nq-accent-blue focus:border-nq-accent-blue mb-6">
            <div class="subject-container">
                <!-- Physics Section -->
                <div class="subject-card">
                    <h3><i class="fas fa-atom"></i> Physics</h3>
                    <ul class="chapter-list">
                        <li><button data-subject="Physics" data-chapter="Force">Force</button></li>
                        <li><button data-subject="Physics" data-chapter="Pressure">Pressure</button></li>
                        <li><button data-subject="Physics" data-chapter="Energy">Energy</button></li>
                        <li><button data-subject="Physics" data-chapter="Light">Light</button></li>
                        <li><button data-subject="Physics" data-chapter="Heat">Heat</button></li>
                        <li><button data-subject="Physics" data-chapter="Current Electricity">Current Electricity</button></li>
                        <li><button data-subject="Physics" data-chapter="Magnetism">Magnetism</button></li>
                        <li><button data-subject="Physics" data-chapter="Sound">Sound</button></li>
                        <li><button data-subject="Physics" data-chapter="Modern Physics">Modern Physics (Radioactivity, Nuclear Energy)</button></li>
                    </ul>
                </div>

                <!-- Chemistry Section -->
                <div class="subject-card">
                    <h3><i class="fas fa-flask"></i> Chemistry</h3>
                    <ul class="chapter-list">
                        <li><button data-subject="Chemistry" data-chapter="Classification of Elements">Classification of Elements</button></li>
                        <li><button data-subject="Chemistry" data-chapter="Chemical Reactions">Chemical Reactions</button></li>
                        <li><button data-subject="Chemistry" data-chapter="Acid, Base and Salt">Acid, Base and Salt</button></li>
                        <li><button data-subject="Chemistry" data-chapter="Metals">Metals (Extraction and Uses)</button></li>
                        <li><button data-subject="Chemistry" data-chapter="Non-metals">Non-metals (Properties and Uses)</button></li>
                        <li><button data-subject="Chemistry" data-chapter="Compounds in Daily Life">Compounds in Daily Life (Water, Ammonia, etc.)</button></li>
                        <li><button data-subject="Chemistry" data-chapter="Carbon and Its Compounds">Carbon and Its Compounds</button></li>
                        <li><button data-subject="Chemistry" data-chapter="Materials Used in Daily Life">Materials Used in Daily Life (Cement, Glass, Plastics, etc.)</button></li>
                    </ul>
                </div>

                <!-- Biology Section -->
                <div class="subject-card">
                    <h3><i class="fas fa-dna"></i> Biology</h3>
                    <ul class="chapter-list">
                        <li><button data-subject="Biology" data-chapter="Cell Structure and Function">Cell Structure and Function</button></li>
                        <li><button data-subject="Biology" data-chapter="Life Processes">Life Processes (Nutrition, Respiration, Transportation, Excretion)</button></li>
                        <li><button data-subject="Biology" data-chapter="Reproduction">Reproduction</button></li>
                        <li><button data-subject="Biology" data-chapter="Heredity">Heredity</button></li>
                        <li><button data-subject="Biology" data-chapter="Evolution">Evolution</button></li>
                        <li><button data-subject="Biology" data-chapter="Environment and Sustainable Development">Environment and Sustainable Development</button></li>
                        <li><button data-subject="Biology" data-chapter="Human Nervous System and Sensory Organs">Human Nervous System and Sensory Organs</button></li>
                        <li><button data-subject="Biology" data-chapter="Diseases and Prevention">Diseases and Prevention</button></li>
                    </ul>
                </div>
            </div>

            <div class="upcoming-quizzes">
                <h3>Coming Soon!</h3>
                <p>New quizzes and study materials for different academic levels will be added regularly.</p>
            </div>
        </div>

        <!-- Quiz Area - Initially Hidden -->
        <div id="quiz-full-area" class="quiz-card hidden">
            <h2 class="text-center mb-4">Quiz Time!</h2>
            <p id="quiz-chapter-info" class="text-center text-nq-text-dark mb-6"></p>

            <div id="status" class="mb-4 flex justify-between items-center">
                <div id="question-num" class="text-nq-text-dark text-lg font-medium"></div>
                <div id="countdown" class="text-nq-accent-blue text-center text-xl font-bold"></div>
            </div>

            <h3 id="question-text" class="text-nq-text-dark text-xl font-semibold mb-6"></h3>
            <div id="options-container" class="space-y-3"></div>
            <div id="explanation" class="text-nq-text-dark mt-4 hidden"></div>

            <div class="controls flex justify-between gap-4 mt-8">
                <button id="prev-btn">Previous</button>
                <button id="skip-btn">Skip</button>
                <button id="next-btn">Next</button>
                <button id="submit-btn">Submit Quiz</button>
            </div>
        </div>

        <!-- Results Area - Initially Hidden -->
        <div id="results-area" class="quiz-card hidden">
            <h2 class="text-center mb-4">Quiz Result</h2>
            <div class="text-center space-y-2 text-nq-text-dark mb-6">
                <div>Total Questions: <span id="res-total" class="font-bold text-nq-text-dark">0</span></div>
                <div>Correct Answers: <span id="res-correct" class="font-bold text-green-600">0</span></div>
                <div>Wrong Answers: <span id="res-wrong" class="font-bold text-red-500">0</span></div>
                <div>Skipped Questions: <span id="res-skipped" class="font-bold text-nq-text-dark">0</span></div>
            </div>
            <div class="controls flex justify-center gap-4 mt-8">
                <button id="save-result-btn">Save Result (Local)</button>
                <button id="restart-btn">Restart Quiz</button>
            </div>

            <h3 class="text-xl font-semibold text-center mt-10 mb-4 text-nq-accent-blue">Your Local History</h3>
            <div id="local-history-display" class="space-y-3">
                <div class="text-nq-text-dark text-center">No previous results saved locally.</div>
            </div>
        </div>
    </div>
</section>

<!-- Footer -->
<footer>
    <div class="footer-content">
        <div class="footer-column">
            <h4>NepalQuiz</h4>
            <p style="color: rgba(255, 255, 255, 0.8);">Your ultimate platform for Nepali quizzes and exam preparations.</p>
        </div>
        <div class="footer-column">
            <h4>Quick Links</h4>
            <ul>
                <li><a href="/index.html">Home</a></li>
                <li><a href="/quizzes.html">Quizzes</a></li>
                <li><a href="/about-us.html">About-Us</a></li>
                <li><a href="/contact.html">Contact Us</a></li>
            </ul>
        </div>
        <div class="footer-column">
            <h4>Categories</h4>
            <ul>
                <li><a href="academic.html">Academic</a></li>
                <li><a href="loksewa.html">Loksewa Prep</a></li>
                <li><a href="nepal-gk.html">Nepal GK</a></li>
                <li><a href="fun.html">Fun Quizzes</a></li>
            </ul>
        </div>
        <div class="footer-column">
            <h4>Connect With Us</h4>
            <div class="social-icons">
                <a href="#" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                <a href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                <a href="#" aria-label="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
            </div>
        </div>
    </div>
    <div class="footer-bottom">
        <p>&copy; 2025 NepalQuiz. All Rights Reserved.</p>
    </div>
</footer>

<!-- Modal for messages -->
<div id="modal-message-overlay" class="modal-overlay hidden">
    <div class="modal-content">
        <button class="modal-close-btn" id="modal-message-close">&times;</button>
        <p id="modal-message-text"></p>
        <button id="modal-message-ok">OK</button>
    </div>
</div>
<script type="module">
    /* =========================
       Firebase Imports & Setup
       ========================= */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Firebase configuration
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
  apiKey: "AIzaSyD6sZ8Hp7MLUyHljZn-qwz2UhwVo5O0SZE",
  authDomain: "nepalquiz-gk.firebaseapp.com",
  projectId: "nepalquiz-gk",
  storageBucket: "nepalquiz-gk.firebasestorage.app",
  messagingSenderId: "579414109480",
  appId: "1:579414109480:web:b762c2f3d14fe58951b41d"
    };

    // Initial authentication token (provided by Canvas environment or null)
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    // Application ID (provided by Canvas environment or default)
    const currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';


    // Gemini API configuration
    const GEMINI_API_KEY = "AIzaSyB_00le4-5PPBhlD71wFYznbFl4cXURDmI"; // Leave empty for Canvas to provide at runtime
    const GEMINI_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
    
    // Local storage keys
    const LOCAL_STORAGE_KEY_RESULTS = "nepalQuizAcademicResults";
    const LOCAL_STORAGE_KEY_NAME = "nepalQuizParticipantName";
    
    // Firestore collection path for academic quizzes
    const QUIZZES_COLLECTION_PATH = `artifacts/${currentAppId}/public/data/academic_quizzes`;


    // Global Firebase instances (initialized later in DOMContentLoaded)
    let app;
    let db;
    let auth;
    let userId;

    /* =========================
       GLOBAL QUIZ STATE
       ========================= */
    let quizData = [];
    let currentQuestionIndex = 0;
    let questionTimer = null;
    let participantName = "";
    let currentSelectedSubject = null;
    let currentSelectedChapter = null;

    /* =========================
       Helper Functions
       ========================= */
    function el(id){ return document.getElementById(id); }
    function show(q){ q.classList.remove('hidden'); q.style.display = ''; }
    function hide(q){ q.classList.add('hidden'); q.style.display = 'none'; }

    function showMessage(msg, callback = null) {
        el('modal-message-text').innerText = msg;
        show(el('modal-message-overlay'));
        el('modal-message-ok').onclick = () => {
            hide(el('modal-message-overlay'));
            if (callback) callback();
        };
        el('modal-message-close').onclick = () => {
            hide(el('modal-message-overlay'));
            if (callback) callback();
        };
    }

    /* =========================
       Local Storage Management
       ========================= */
    function saveParticipantNameLocally(name) {
        localStorage.setItem(LOCAL_STORAGE_KEY_NAME, name);
    }

    function getParticipantNameLocally() {
        return localStorage.getItem(LOCAL_STORAGE_KEY_NAME) || "";
    }

    function saveQuizResultLocally(result) {
        const results = getQuizResultsLocally();
        results.push(result);
        localStorage.setItem(LOCAL_STORAGE_KEY_RESULTS, JSON.stringify(results));
        renderLocalHistory();
    }

    function getQuizResultsLocally() {
        try {
            return JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY_RESULTS) || "[]"); // Fixed missing parenthesis
        } catch (e) {
            console.error("Error parsing local results:", e);
            return [];
        }
    }

    function renderLocalHistory() {
        const historyDisplayEl = el('local-history-display');
        const results = getQuizResultsLocally();

        if (results.length === 0) {
            historyDisplayEl.innerHTML = '<div class="text-nq-text-dark text-center">No previous results saved locally.</div>';
            return;
        }

        results.sort((a, b) => new Date(b.date) - new Date(a.date));

        historyDisplayEl.innerHTML = results.map(r => {
            const dateStr = new Date(r.date).toLocaleString('en-NP', {
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit', hour12: true
            });
            return `
                <div class="participant flex justify-between items-center p-3 rounded-lg bg-nq-background-light border border-nq-primary-blue mb-2">
                    <div>
                        <strong class="text-nq-accent-blue">${escapeHtml(r.name || 'Anonymous')}</strong><br>
                        <span class="text-nq-text-dark text-sm">
                            Subject: ${escapeHtml(r.subject)}, Chapter: ${escapeHtml(r.chapter)} on ${dateStr}
                        </span>
                    </div>
                    <div class="text-nq-text-dark">${r.correct} / ${r.total} Correct (${r.skipped} skipped)</div>
                </div>
            `;
        }).join('');
    }

    /* =========================
       Exponential Backoff for API calls
       ========================= */
    async function fetchWithExponentialBackoff(url, options, retries = 3, delay = 1000) {
        for (let i = 0; i < retries; i++) {
            try {
                const response = await fetch(url, options);
                if (response.status === 429 || !response.ok) { // Too Many Requests or other non-OK status
                    if (i < retries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                        continue;
                    }
                }
                return response;
            } catch (error) {
                if (i < retries - 1) {
                    await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                    continue;
                }
                throw error; // Re-throw if all retries fail
            }
        }
    }

    /* =========================
       Firestore Functions
       ========================= */
    function getQuizDocId(subjectName, chapterName) {
        const sanitizedSubject = subjectName.replace(/[^a-zA-Z0-9\s]/g, '').toLowerCase().replace(/\s+/g, '_');
        const sanitizedChapter = chapterName.replace(/[^a-zA-Z0-9\s]/g, '').toLowerCase().replace(/\s+/g, '_');
        return `${sanitizedSubject}_${sanitizedChapter}`;
    }

    async function getQuizFromFirestore(subjectName, chapterName) {
        const topicDisplay = `${subjectName} - ${chapterName}`;
        showMessage(`Checking for existing questions for "${topicDisplay}"...`);
        try {
            if (!db) {
                console.error("Firestore DB not initialized.");
                return null;
            }

            const docId = getQuizDocId(subjectName, chapterName);
            const docRef = doc(db, QUIZZES_COLLECTION_PATH, docId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                showMessage(`Questions for "${topicDisplay}" loaded from cache!`);
                return docSnap.data().quizData;
            }
            return null;
        } catch (e) {
            console.error("Error fetching quiz from Firestore:", e);
            showMessage(`Error fetching quiz from database: ${e.message}`);
            return null;
        }
    }

    async function saveQuizToFirestore(subjectName, chapterName, quizQuestions) {
        try {
            if (!db) {
                console.error("Firestore DB not initialized.");
                return;
            }
            const docId = getQuizDocId(subjectName, chapterName);
            const docRef = doc(db, QUIZZES_COLLECTION_PATH, docId);
            await setDoc(docRef, {
                subject: subjectName,
                chapter: chapterName,
                quizData: quizQuestions,
                generatedAt: new Date().toISOString(),
                userId: userId
            });
            console.log("Quiz data saved to Firestore for:", docId);
        } catch (e) {
            console.error("Error saving quiz to Firestore:", e);
            showMessage(`Error saving quiz to database: ${e.message}`);
        }
    }

    /* =========================
       Gemini API Functions
       ========================= */
    async function generateMCQs(subject, chapter) {
        const topicForPrompt = `${chapter} in ${subject}`;
        showMessage(`Generating questions for "${topicForPrompt}" — please wait... (This may take a moment)`, null);
        const prompt = `
Generate 30 multiple choice questions in JSON (array) for a quiz on the topic "${topicForPrompt}" for a high school level on a Nepali educational platform. Each question must have exactly 4 options. Ensure the correct option is clearly indicated by its 0-indexed position (0-3). Provide a short explanation for the correct answer. The questions should be relevant to academic content.

Use exactly this JSON schema:
[
  {
    "question": "text of the question",
    "options": ["Option A","Option B","Option C","Option D"],
    "correct": 0, // index of the correct option (0 for A, 1 for B, etc.)
    "explanation": "short explanation for the correct answer"
  }
]
Return JSON array only. Do not include any other text or markdown outside the JSON.
`.trim();

        const payload = {
            contents: [{ role: "user", parts: [{ text: prompt }] }],
            generationConfig: { responseMimeType: "application/json" }
        };

        try {
            const response = await fetchWithExponentialBackoff(GEMINI_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`Gemini API failed: ${response.status}`);
            }
            
            const json = await response.json();
            const raw = json?.candidates?.[0]?.content?.parts?.[0]?.text || '';
            let parsed;
            
            try {
                parsed = JSON.parse(raw);
            } catch (parseError) {
                throw new Error(`Failed to parse JSON from Gemini API: ${parseError.message}. Raw response: ${raw}`);
            }

            if (!Array.isArray(parsed) || parsed.length === 0) {
                throw new Error("Gemini returned an empty or invalid quiz data structure.");
            }
            
            showMessage(`Questions for "${topicForPrompt}" generated successfully!`);
            return parsed.filter(q => q.question && Array.isArray(q.options) && q.options.length === 4 && typeof q.correct === 'number' && q.correct >= 0 && q.correct <= 3 && q.explanation);
        } catch (e) {
            console.error("Gemini error", e);
            showMessage(`Failed to generate questions: ${e.message}. Please try again.`);
            throw e;
        }
    }

    /* =========================
       Quiz UI Functions
       ========================= */
    function renderQuestion() {
        if (!quizData.length) {
            el('question-text').innerText = "No questions loaded.";
            el('options-container').innerHTML = '';
            hide(el('explanation'));
            el('question-num').innerText = '';
            el('countdown').innerText = '';
            return;
        }

        const q = quizData[currentQuestionIndex];
        el('question-num').innerText = `Question ${currentQuestionIndex + 1} / ${quizData.length}`;
        el('question-text').innerText = q.question || '';
        hide(el('explanation'));
        el('explanation').innerText = '';
        const cont = el('options-container'); cont.innerHTML = '';

        // Get CSS variables for dynamic styling
        const rootStyles = getComputedStyle(document.documentElement);
        const cssVarLightGreen = rootStyles.getPropertyValue('--light-green');
        const cssVarLightRed = rootStyles.getPropertyValue('--light-red');
        const cssVarGreen = rootStyles.getPropertyValue('--green');
        const cssVarRed = rootStyles.getPropertyValue('--red');
        const cssVarPrimaryBlue = rootStyles.getPropertyValue('--nq-primary-blue');
        const cssVarTextDark = rootStyles.getPropertyValue('--nq-text-dark');
        const cssVarBackgroundLight = rootStyles.getPropertyValue('--nq-background-light');

        (q.options || []).forEach((opt, i) => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = opt;
            btn.dataset.index = i;
            btn.dataset.answered = q.answered ? 'true' : 'false';

            if (q.answered) {
                if (i === q.userAnswer) {
                    btn.style.backgroundColor = i === q.correct ? cssVarLightGreen : cssVarLightRed;
                    btn.style.borderColor = i === q.correct ? cssVarGreen : cssVarRed;
                    btn.style.color = cssVarTextDark;
                } else if (i === q.correct) {
                    btn.style.backgroundColor = cssVarLightGreen;
                    btn.style.borderColor = cssVarGreen;
                    btn.style.color = cssVarTextDark;
                } else {
                    btn.style.backgroundColor = cssVarBackgroundLight;
                    btn.style.borderColor = cssVarPrimaryBlue;
                    btn.style.color = cssVarTextDark;
                }
                show(el('explanation'));
                el('explanation').innerText = (q.userAnswer === q.correct ? '✅ Correct. ' : '❌ Incorrect. Correct answer: ' + (q.options && q.options[q.correct] ? q.options[q.correct] : '')) + (q.explanation ? ' — ' + q.explanation : '');
            } else {
                btn.style.backgroundColor = cssVarBackgroundLight;
                btn.style.borderColor = cssVarPrimaryBlue;
                btn.style.color = cssVarTextDark;
            }


            btn.onclick = () => {
                if (q.answered) return;
                q.answered = true;
                q.userAnswer = i;
                btn.dataset.answered = 'true';

                Array.from(cont.children).forEach(optionBtn => {
                    const optionIndex = parseInt(optionBtn.dataset.index);
                    if (optionIndex === i) {
                        optionBtn.style.backgroundColor = i === q.correct ? cssVarLightGreen : cssVarLightRed;
                        optionBtn.style.borderColor = i === q.correct ? cssVarGreen : cssVarRed;
                        optionBtn.style.color = cssVarTextDark;
                    } else if (optionIndex === q.correct) {
                        optionBtn.style.backgroundColor = cssVarLightGreen;
                        optionBtn.style.borderColor = cssVarGreen;
                        optionBtn.style.color = cssVarTextDark;
                    } else {
                        optionBtn.style.backgroundColor = cssVarBackgroundLight;
                        optionBtn.style.borderColor = cssVarPrimaryBlue;
                        optionBtn.style.color = cssVarTextDark;
                    }
                });

                show(el('explanation'));
                el('explanation').innerText = (i === q.correct ? '✅ Correct. ' : '❌ Incorrect. Correct answer: ' + (q.options && q.options[q.correct] ? q.options[q.correct] : '')) + (q.explanation ? ' — ' + q.explanation : '');
                clearInterval(questionTimer);
            };
            cont.appendChild(btn);
        });

        el('prev-btn').disabled = currentQuestionIndex === 0;
        el('next-btn').disabled = currentQuestionIndex === quizData.length - 1;
        el('skip-btn').disabled = q.answered;
        el('submit-btn').disabled = false;

        if (!q.answered) {
            startQuestionTimer();
        } else {
            clearInterval(questionTimer);
            el('countdown').innerText = 'Time: 0s (Answered)';
        }
    }

    function startQuestionTimer() {
        let timeLeft = 30;
        el('countdown').innerText = `Time: ${timeLeft}s`;
        if (questionTimer) clearInterval(questionTimer);
        questionTimer = setInterval(() => {
            timeLeft--;
            el('countdown').innerText = `Time: ${timeLeft}s`;
            if (timeLeft <= 0) {
                clearInterval(questionTimer);
                if (!quizData[currentQuestionIndex].answered) {
                    quizData[currentQuestionIndex].skipped = true;
                    quizData[currentQuestionIndex].answered = true;
                    quizData[currentQuestionIndex].userAnswer = null;
                }
                if (currentQuestionIndex < quizData.length - 1) { 
                    currentQuestionIndex++; 
                    renderQuestion(); 
                } else {
                    submitQuiz();
                }
            }
        }, 1000);
    }

    function nextQuestion() {
        if (!quizData[currentQuestionIndex].answered) {
            quizData[currentQuestionIndex].skipped = true;
            quizData[currentQuestionIndex].answered = true;
            quizData[currentQuestionIndex].userAnswer = null;
        }

        if (currentQuestionIndex < quizData.length - 1) {
            currentQuestionIndex++; 
            renderQuestion();
        } else {
            submitQuiz();
        }
    }

    function prevQuestion() {
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--; 
            renderQuestion();
        }
    }

    function skipQuestion() {
        if (!quizData[currentQuestionIndex].answered) {
            quizData[currentQuestionIndex].skipped = true;
            quizData[currentQuestionIndex].answered = true;
            quizData[currentQuestionIndex].userAnswer = null;
        }
        nextQuestion();
    }

    function submitQuiz() {
        if (questionTimer) clearInterval(questionTimer);

        if (!quizData[currentQuestionIndex].answered) {
            quizData[currentQuestionIndex].skipped = true;
            quizData[currentQuestionIndex].answered = true;
            quizData[currentQuestionIndex].userAnswer = null;
        }

        let correct = 0, wrong = 0, skipped = 0;
        quizData.forEach(q => {
            if (q.answered && q.userAnswer !== null && q.userAnswer === q.correct) correct++;
            else if (q.answered && q.userAnswer !== null && q.userAnswer !== q.correct) wrong++;
            else if (q.skipped) skipped++;
        });

        el('res-total').innerText = quizData.length;
        el('res-correct').innerText = correct;
        el('res-wrong').innerText = wrong;
        el('res-skipped').innerText = skipped;

        hide(el('quiz-full-area'));
        show(el('results-area'));
        el('save-result-btn').disabled = false;
        renderLocalHistory();
    }

    /* =========================
       Main Quiz Flow
       ========================= */
    async function generateAndRenderQuiz(subjectName, chapterName) {
        currentSelectedSubject = subjectName;
        currentSelectedChapter = chapterName;
        const topicDisplay = `${subjectName} - ${chapterName}`;

        hide(el('chapter-selection-area'));
        show(el('quiz-full-area'));

        el('quiz-chapter-info').innerText = `Loading quiz for: ${topicDisplay}...`;
        el('question-text').innerText = 'Please wait, fetching questions...';
        el('options-container').innerHTML = '';
        el('prev-btn').disabled = true;
        el('next-btn').disabled = true;
        el('skip-btn').disabled = true;
        el('submit-btn').disabled = true;

        try {
            // Initialize Firebase auth if not already done, within the quiz flow
            if (!auth.currentUser) {
                try {
                    await signInAnonymously(auth);
                } catch (authError) {
                    console.error("Anonymous authentication error:", authError);
                    // Fallback to a random ID if anonymous sign-in fails, so app can still proceed
                    userId = crypto.randomUUID();
                }
                userId = auth.currentUser?.uid || crypto.randomUUID();
            }


            let fetchedQuizData = await getQuizFromFirestore(subjectName, chapterName);

            if (!fetchedQuizData || fetchedQuizData.length === 0) {
                fetchedQuizData = await generateMCQs(subjectName, chapterName);
                if (fetchedQuizData && fetchedQuizData.length > 0) {
                    await saveQuizToFirestore(subjectName, chapterName, fetchedQuizData);
                } else {
                    throw new Error("Could not generate quiz data");
                }
            }

            quizData = fetchedQuizData.map(q => ({ ...q, answered: false, userAnswer: null, skipped: false }));
            currentQuestionIndex = 0;
            el('quiz-chapter-info').innerText = `Quiz on: ${topicDisplay}`;
            renderQuestion();
        } catch (error) {
            console.error("Error generating/loading quiz:", error);
            showMessage(`Failed to load quiz for "${topicDisplay}": ${error.message || error}. Please try again.`);
            hide(el('quiz-full-area'));
            show(el('chapter-selection-area'));
        }
    }

    function showPage() {
        hide(el('quiz-full-area'));
        hide(el('results-area'));
        show(el('chapter-selection-area'));
        renderLocalHistory();
    }

    function escapeHtml(str) {
        return String(str).replace(/[&<>"']/g, s => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[s]));
    }

    /* =========================
       Event Listeners
       ========================= */
    document.addEventListener('DOMContentLoaded', async () => {
        // Firebase Initialization
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // Initial authentication (only once on page load)
            if (initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                } catch (customTokenError) {
                    console.warn("Custom token sign-in failed, attempting anonymous sign-in:", customTokenError);
                    await signInAnonymously(auth);
                }
            } else {
                await signInAnonymously(auth);
            }
            userId = auth.currentUser?.uid || crypto.randomUUID();
            console.log("Firebase initialized and user signed in. User ID:", userId);
        } catch (error) {
            console.error("Error initializing Firebase or signing in:", error);
            showMessage(`Error initializing app: ${error.message}. Quiz features may not work.`);
            // If Firebase init fails, the app might not function correctly for quiz generation/storage
            // but chapter selection and basic UI will still be available.
            return;
        }

        // Add event listeners to all chapter buttons
        const chapterButtons = document.querySelectorAll('.chapter-list button');
        chapterButtons.forEach(button => {
            button.addEventListener('click', () => {
                const subject = button.dataset.subject;
                const chapter = button.dataset.chapter;
                generateAndRenderQuiz(subject, chapter);
            });
        });

        // Quiz navigation buttons
        el('prev-btn').onclick = prevQuestion;
        el('next-btn').onclick = nextQuestion;
        el('skip-btn').onclick = skipQuestion;
        el('submit-btn').onclick = submitQuiz;

        el('restart-btn').onclick = () => {
            hide(el('quiz-full-area'));
            hide(el('results-area'));
            show(el('chapter-selection-area'));
            quizData = [];
            currentQuestionIndex = 0;
            currentSelectedSubject = null;
            currentSelectedChapter = null;
            if (questionTimer) clearInterval(questionTimer);
            renderLocalHistory();
        };

        el('save-result-btn').onclick = async () => {
            const result = {
                name: getParticipantNameLocally() || 'Anonymous',
                subject: currentSelectedSubject,
                chapter: currentSelectedChapter,
                date: new Date().toISOString(),
                total: quizData.length,
                correct: parseInt(el('res-correct').innerText),
                wrong: parseInt(el('res-wrong').innerText),
                skipped: parseInt(el('res-skipped').innerText)
            };
            saveQuizResultLocally(result);
            showMessage('Your quiz result has been saved locally!');
            el('save-result-btn').disabled = true;
        };

        // Participant name input handling
        const participantNameInput = el('participant-name-input');
        if (participantNameInput) {
            participantNameInput.value = getParticipantNameLocally();
            participantNameInput.addEventListener('input', (e) => saveParticipantNameLocally(e.target.value));
        }

        // Initialize display
        renderLocalHistory();
        showPage();
    });
</script>

</body>
</html>
